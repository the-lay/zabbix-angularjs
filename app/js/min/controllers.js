/*! angular 2013-05-02 */
"use strict";function loginController(e,t,r,o,s){$("#inputName").focus(),e.login=function(){r.auth_id=Date.now(),s.add("auth_id",r.auth_id),t.post(api_url,{jsonrpc:"2.0",method:"user.login",auth:r.auth,params:{user:e.inputName,password:e.inputPassword},id:r.auth_id}).success(function(n){n.error?(e.error=n.error,$("#inputName").focus()):(s.add("auth",n.result),r.auth=n.result,r.loggedIn=!0,e.inputName="",e.inputPassword="",$("#inputName").focus(),t.post(api_url,{jsonrpc:"2.0",id:r.auth_id,auth:r.auth,method:"host.get",params:{output:["name"],sortfield:"name"}}).success(function(e){r.serversOnline=e.result,o.path("/")}))})}}function logoutController(e,t,r,o){t.loggedIn?r.post(api_url,{jsonrpc:"2.0",id:t.auth_id,auth:t.auth,method:"user.logout",params:{}}).success(function(){t.loggedIn=!1,t.auth=null,t.auth_id=null,e.clearAll(),e.cookie.clearAll(),o.path("/login")}):o.path("/login")}function menuController(e,t){$(".nav-collapse a").click(function(){$("#collapsingBtn").is(":visible")&&$(".nav-collapse").collapse("toggle")}),e.findServer=function(){e.searchQuery&&t.path("/search/"+e.searchQuery),e.searchQuery=""}}function overviewController(e,t,r,o){if(e.loggedIn){t.groupErrorsPluralize={0:" ",one:"{} error!",other:"{} errors!"},t.triggerSeverity=["Fine","Information","Warning","Average","High","Disaster"];var s=r.post(api_url,{jsonrpc:"2.0",id:e.auth_id,auth:e.auth,method:"hostgroup.get",params:{output:["groupid","name"],sortfield:"name",real_hosts:!0},filter:{name:"project"}}),n=r.post(api_url,{jsonrpc:"2.0",id:e.auth_id,auth:e.auth,method:"trigger.get",params:{selectGroups:"refer",expandDescription:!0,expandData:!0,only_true:!0,sortfield:"lastchange",filter:{value:1},skipDependent:!0,monitored:!0,output:["triggerid","priority","lastchange","description"]}}).success(function(e){for(var t=0;e.result.length>t;t++)e.result[t].lastchange_words=dateConverter(e.result[t].lastchange)});o.all([s,n]).then(function(e){function r(e){for(var t=o.defer(),r=e.length-1;r>=0;r--)e[r].lastchange=0,e[r].lastchange_words="",e[r].errors=0,e[r].errors_level=0,a[e[r].groupid]=[];return t.resolve(),t.promise}var s=e[0].data.result,n=e[1].data.result,a={},i=r(s);i.then(function(){for(var e=0;s.length>e;e++)for(var r=0;n.length>r;r++)n[r].groups[0].groupid===s[e].groupid&&(s[e].errors+=1,a[s[e].groupid].push(n[r]),n[r].lastchange>s[e].lastchange&&(s[e].lastchange=n[r].lastchange,s[e].lastchange_words=dateConverter(n[r].lastchange)),n[r].priority>s[e].errors_level&&(s[e].errors_level=n[r].priority));t.serverGroups=s,t.triggerDetails=a})})}}function serversController(e,t,r){e.loggedIn&&r.post(api_url,{jsonrpc:"2.0",id:e.auth_id,auth:e.auth,method:"host.get",params:{monitored_hosts:!0,output:["name","available","hostid","host"]}}).success(function(e){t.hostsData=e.result}),$("#filterInput").focus()}function serversDetailsController(e,t,r,o,s){e.loggedIn&&(o.serverId||s.path("/"),r.post(api_url,{jsonrpc:"2.0",id:e.auth_id,auth:e.auth,method:"host.get",params:{selectInventory:!0,selectItems:["name","lastvalue","units","itemid","lastclock"],output:"extend",hostids:o.serverId}}).success(function(e){if(t.inventoryData=e.result[0].inventory,t.serverName=e.result[0].name,t.zabbix_url=zabbix_url,t.hostId=o.serverId,t.itemsData=e.result[0].items)for(var r=t.itemsData.length-1;r>=0;r--)t.itemsData[r].lastclock=dateConverter(t.itemsData[r].lastclock,"time")}))}function projectController(e,t,r,o,s){e.loggedIn&&(o.projectId||s.path("/"),r.post(api_url,{jsonrpc:"2.0",id:e.auth_id,method:"hostgroup.get",auth:e.auth,params:{groupids:o.projectId,output:["groupid","name"],sortfield:"name",selectHosts:["hostid","available","host","status","name"],real_hosts:!0,monitored_hosts:!0}}).success(function(e){t.hostgroupData=e.result[0]})),$("#filterInput").focus()}function dashboardController(e,t,r,o,s){function n(){return $(".server").tooltip("destroy").removeClass("error1 error2 error3 error4 error5"),!0}function a(e){for(var t=e.length-1;t>=0;t--)$("#"+e[t].hosts[0].hostid).tooltip({title:e[t].description}).addClass("error"+e[t].priority)}r.fullscreen="padding-left:2px; padding-right:2px;",e.selectedGroups={};var i=!0,l=!0;(function u(){return"/dashboard"!==o.path()?(r.fullscreen="",void 0):(t.post(api_url,{jsonrpc:"2.0",id:r.auth_id,auth:r.auth,method:"hostgroup.get",params:{real_hosts:!0,monitored_hosts:!0,output:["groupid","name"],selectHosts:["hostid","available","name","host","status"],sortfield:"name"}}).success(function(t){if(e.hostgroupsData=t.result,null===s.get("selectedGroups"))for(var r=t.result.length-1;r>=0;r--)e.selectedGroups[t.result[r].groupid]=!0,s.add("selectedGroups",JSON.stringify(e.selectedGroups));else e.selectedGroups=JSON.parse(s.get("selectedGroups"))}),setTimeout(u,hostgroupUpdateInterval),void 0)})(),function c(){return"/dashboard"!==o.path()?(r.fullscreen="",void 0):(t.post(api_url,{jsonrpc:"2.0",id:r.auth_id,auth:r.auth,method:"trigger.get",params:{expandDescription:!0,expandData:!0,sortfield:"priority",selectGroups:"refer",selectHosts:"refer",filter:{value:1},skipDependent:!0,monitored:!0,only_true:!0,output:["description","lastchange","priority","triggerid"]}}).success(function(t){e.triggersData=t.result,e.lastUpdated=timeConverter((new Date).getTime()),i?e.$on("serversRenderingFinished",function(){i&&(n(t.result,"firstTime")&&a(t.result,"firstTime"),i=!1)}):n(t.result,"NOT firstTime")&&a(t.result,"NOT firstTime"),e.$on("triggersRenderingFinished",function(){$('div[id^="notification-"]').hover(function(){$("#"+$(this).attr("id").substring(13)).addClass("zoomUp")},function(){$("#"+$(this).attr("id").substring(13)).removeClass("zoomUp")})})}),setTimeout(c,triggerUpdateInterval),void 0)}(),e.selectGroup=function(t){e.selectedGroups[t]===!0?(e.selectedGroups[t]=!1,s.add("selectedGroups",JSON.stringify(e.selectedGroups))):(e.selectedGroups[t]=!0,s.add("selectedGroups",JSON.stringify(e.selectedGroups)))},e.toggleGroupSelector=function(){$("#groups").animate({height:"toggle"},"slow"),l?(l=!1,e.groupSelectorShown="Show"):(l=!0,e.groupSelectorShown="Hide")}}function searchController(e,t,r,o,s){if(t.searchPhrase=o.searchString,o.searchString||s.path("/"),$("#serverSearch").blur(),e.loggedIn){for(var n=e.serversOnline.length-1;n>=0;n--)e.serversOnline[n].name===o.searchString&&s.path("/servers/"+e.serversOnline[n].hostid);r.post(api_url,{jsonrpc:"2.0",id:e.auth_id,method:"host.get",auth:e.auth,params:{monitored_hosts:!0,output:["name","hostid"],search:{name:o.searchString},sortfield:"name"}}).success(function(e){t.hostsData=e.result}),r.post(api_url,{jsonrpc:"2.0",id:e.auth_id,method:"hostgroup.get",auth:e.auth,params:{output:["groupid","name"],sortfield:"name",real_hosts:!0,search:{name:o.searchString}}}).success(function(e){t.groupsData=e.result})}}